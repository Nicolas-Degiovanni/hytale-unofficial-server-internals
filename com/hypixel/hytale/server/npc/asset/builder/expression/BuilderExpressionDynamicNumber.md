---
description: Architectural reference for BuilderExpressionDynamicNumber
---

# BuilderExpressionDynamicNumber

**Package:** com.hypixel.hytale.server.npc.asset.builder.expression
**Type:** Transient

## Definition
```java
// Signature
public class BuilderExpressionDynamicNumber extends BuilderExpressionDynamic {
```

## Architecture & Concepts
The BuilderExpressionDynamicNumber class is a concrete implementation within the server's dynamic expression evaluation engine. It represents a pre-compiled, executable script that is guaranteed to resolve to a numeric (double) value at runtime.

This class acts as a specialized "command" object. It encapsulates the low-level instruction sequence (bytecode) generated by parsing a string expression from an asset file. Its primary role is to separate the static definition of a calculation from the dynamic, runtime context in which it is executed. By doing so, a single compiled expression instance can be efficiently and safely evaluated many times with different inputs (e.g., for multiple NPC agents or across different game ticks).

It is a terminal component in the expression system, responsible for executing bytecode and extracting a final numeric result from the evaluation stack.

### Lifecycle & Ownership
- **Creation:** Instances are not created directly. They are instantiated by a central expression parser or factory during the asset loading phase. The factory consumes a string from a configuration file (e.g., "5 * self.health") and compiles it into an instruction sequence, which is then provided to this class's constructor.
- **Scope:** The lifetime of a BuilderExpressionDynamicNumber object is bound to the parent asset that defines it, such as an NPC behavior configuration or a scripted quest trigger. It persists as long as the asset is loaded in memory.
- **Destruction:** The object is eligible for garbage collection when its containing asset is unloaded by the AssetManager. There is no manual destruction or cleanup required.

## Internal State & Concurrency
- **State:** This object is effectively immutable. Its internal state, consisting of the original expression string and the compiled instruction sequence, is set at construction and never modified. The class itself is stateless with respect to execution; all transient data required for a calculation is stored within the passed-in ExecutionContext object.
- **Thread Safety:** This class is inherently thread-safe. The core evaluation methods operate exclusively on the state of the provided ExecutionContext instance. The same BuilderExpressionDynamicNumber instance can be safely executed by multiple threads concurrently, provided that each thread supplies its own distinct ExecutionContext.

**WARNING:** While the class itself is thread-safe, the ExecutionContext object is not. Sharing an ExecutionContext across threads without proper synchronization will lead to stack corruption and unpredictable behavior.

## API Surface
The public API provides the contract for executing the compiled expression and retrieving its result.

| Symbol | Type | Complexity | Description |
| :--- | :--- | :--- | :--- |
| getNumber(ExecutionContext) | double | O(N) | Executes the instruction sequence against the context and returns the resulting number from the stack. N is the number of instructions. |
| updateScope(StdScope, String, ExecutionContext) | void | O(N) | Evaluates the expression and applies the numeric result to a named variable within the provided scope. |
| getType() | ValueType | O(1) | Returns the static type of the expression's result, which is always ValueType.NUMBER. |

## Integration Patterns

### Standard Usage
The intended use is to retrieve a pre-compiled expression from a loaded asset and evaluate it against a context specific to the current game state.

```java
// Assume 'npcBehavior' is a loaded asset containing the expression
BuilderExpressionDynamicNumber damageExpression = npcBehavior.getDamageFormula();

// Create a fresh context for this specific evaluation
ExecutionContext context = new ExecutionContext();
context.setTarget(currentTarget);
context.setSelf(thisNpc);

// Evaluate the expression to get the result
double calculatedDamage = damageExpression.getNumber(context);
```

### Anti-Patterns (Do NOT do this)
- **Direct Instantiation:** Never use `new BuilderExpressionDynamicNumber()`. The instruction sequence is an internal implementation detail. Always rely on the expression parsing service to create and configure these objects.
- **Context Reuse Without Reset:** Reusing an ExecutionContext for different, unrelated expressions without clearing its stack can lead to stack underflow/overflow exceptions and incorrect calculations. Always use a fresh or reset context for a new, top-level evaluation.

## Data Pipeline
This class is a key step in the transformation of declarative configuration into runtime game logic.

> Flow:
> NPC Asset File (JSON/YAML with string "5 * self.health") -> Expression Parsing Service -> **BuilderExpressionDynamicNumber (Instance with Bytecode)** -> Game Logic Tick -> Evaluation with ExecutionContext -> Result (double)

