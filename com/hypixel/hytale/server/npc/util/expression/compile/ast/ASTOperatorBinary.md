---
description: Architectural reference for ASTOperatorBinary
---

# ASTOperatorBinary

**Package:** com.hypixel.hytale.server.npc.util.expression.compile.ast
**Type:** Transient

## Definition
```java
// Signature
public class ASTOperatorBinary extends ASTOperator {
```

## Architecture & Concepts
ASTOperatorBinary is a non-terminal node within the Abstract Syntax Tree (AST) generated by the server-side NPC expression compiler. It represents a binary operation, such as addition, subtraction, or logical AND, which takes exactly two operands (a left-hand side and a right-hand side).

This class is a cornerstone of the expression evaluation system. During the parsing phase, when the compiler encounters an operator token, it consumes two preceding operands from the stack and encapsulates them, along with the operator itself, into an ASTOperatorBinary node. This new node is then pushed back onto the stack, effectively reducing the expression according to operator precedence rules.

A critical architectural feature of this class is its role in **compile-time constant folding**. The static factory method, fromBinaryOperator, inspects its potential operands. If both the left and right-hand side nodes are constants, it immediately executes the operation using a temporary ExecutionContext. The result is then wrapped in a new, constant ASTOperand node, which replaces the original operator and operands on the stack. This optimization pre-calculates constant expressions, significantly reducing the number of instructions generated for runtime execution.

## Lifecycle & Ownership
- **Creation:** ASTOperatorBinary nodes are exclusively created by the static factory method `fromBinaryOperator`. This method is invoked by the expression `Parser` during its processing of the token stream. Direct instantiation is a critical anti-pattern.
- **Scope:** The lifetime of an ASTOperatorBinary instance is tied to the `CompileContext` and the AST it belongs to. It is a short-lived, transient object that exists only for the duration of a single expression compilation.
- **Destruction:** Once the AST is fully built and translated into a list of executable instructions, the tree, including all its ASTOperatorBinary nodes, is no longer referenced and becomes eligible for standard garbage collection. There is no manual destruction or cleanup process.

## Internal State & Concurrency
- **State:** An ASTOperatorBinary node is effectively immutable after construction. It holds final references to its child nodes (the left and right operands) and the associated operator metadata. Its state does not change during its lifetime.
- **Thread Safety:** The class itself is inherently thread-safe due to its immutability. However, the environment in which it operates is **not**. The `CompileContext`, particularly its operand stack, is stateful and designed for single-threaded access. The entire expression compilation process must be performed by a single thread to prevent stack corruption and race conditions.

**WARNING:** Never share a `CompileContext` instance across multiple threads. The compilation pipeline is not re-entrant or thread-safe.

## API Surface
The primary public contract is the static factory method. The constructor is public but should be considered an internal implementation detail.

| Symbol | Type | Complexity | Description |
| :--- | :--- | :--- | :--- |
| fromBinaryOperator(operator, context) | static void | O(C) | Factory method. Pops two operands, performs type checking, attempts constant folding, and pushes a new AST node onto the context's operand stack. Throws ParseException on type mismatch or insufficient operands. Complexity is constant relative to expression size. |
| isConstant() | boolean | O(1) | Overridden to always return false. An operation node is never considered a constant itself, even if its result can be folded at compile time. |

## Integration Patterns

### Standard Usage
Direct interaction with this class is not intended for typical engine developers. It is an internal component of the expression compilation pipeline, orchestrated by the `Parser`. The parser is responsible for invoking `fromBinaryOperator` at the correct time based on operator precedence and associativity.

```java
// This code is conceptual and resides within the Parser logic.
// A developer would not write this.

// When the parser encounters a binary operator token...
Parser.ParsedToken operatorToken = ...;
CompileContext context = ...;

// It invokes the factory to reduce the stack and build the AST node.
ASTOperatorBinary.fromBinaryOperator(operatorToken, context);
```

### Anti-Patterns (Do NOT do this)
- **Direct Instantiation:** Never call `new ASTOperatorBinary(...)`. The static factory `fromBinaryOperator` contains essential logic for type resolution and constant folding. Bypassing it will produce an unoptimized and potentially incorrect AST.
- **Manual Stack Manipulation:** Do not manipulate the `CompileContext` operand stack before or after calling `fromBinaryOperator`. The method has strict expectations about the state of the stack (requiring two operands to be present) and guarantees its own state changes.
- **Ignoring isConstant:** Relying on an ASTOperatorBinary instance to be a constant is a design flaw. The `isConstant` method correctly returns false, and logic should handle it as a dynamic computation unless it has been folded away by the factory method during compilation.

## Data Pipeline
ASTOperatorBinary acts as a transformation stage within the compilation data pipeline, converting a sequence of tokens and operand nodes into a more structured tree node.

> Flow:
> Expression String -> Tokenizer -> Parser -> **ASTOperatorBinary.fromBinaryOperator** -> AST Node on Operand Stack -> Final AST -> Instruction List -> ExecutionContext

