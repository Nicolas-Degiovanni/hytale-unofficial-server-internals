---
description: Architectural reference for ASTOperand
---

# ASTOperand

**Package:** com.hypixel.hytale.server.npc.util.expression.compile.ast
**Type:** Abstract Factory & Base Class

## Definition
```java
// Signature
public abstract class ASTOperand extends AST {
```

## Architecture & Concepts
The ASTOperand class is a foundational component within the server's NPC expression compilation engine. It serves a dual purpose: it is the abstract base class for all terminal nodes in an Abstract Syntax Tree (AST), and it acts as a centralized factory for creating concrete operand instances.

In the context of an expression like `health > 50`, the symbols `health` and `50` are operands. ASTOperand provides the abstraction for these values, while concrete subclasses like ASTOperandIdentifier and ASTOperandNumber provide the specific implementations.

This class embodies the Factory Method pattern. The static `createFromParsedToken` method decouples the Parser from the concrete operand types. The Parser identifies a token as an operand (e.g., a number, a string literal, or an identifier) and delegates its construction to this factory. The factory then inspects the token and its context to instantiate the correct, type-safe AST node. This design is critical for the extensibility of the expression language, allowing new operand types to be added without modifying the core parsing logic.

## Lifecycle & Ownership
- **Creation:** ASTOperand instances are never created directly. They are instantiated exclusively by the static factory methods within this class, primarily `createFromParsedToken`. This process occurs during the compilation phase when the Parser consumes a stream of tokens to build the AST.
- **Scope:** The lifetime of an ASTOperand object is bound to the AST it belongs to. It is a transient object that exists as a node within a larger tree structure representing a single compiled expression.
- **Destruction:** Instances are managed by the Java Garbage Collector. They are eligible for cleanup when the root of their AST (the compiled expression object) is no longer referenced. There is no manual destruction or resource management required.

## Internal State & Concurrency
- **State:** An ASTOperand and its subclasses are designed to be **immutable**. Their state, which includes the value type and the raw token information, is set at creation time and is not intended to be modified thereafter. Subclasses hold the actual literal value (e.g., a double for a number, a String for a string literal).
- **Thread Safety:** The class is inherently thread-safe. Since instances are immutable, they can be safely read by multiple threads. The static factory methods are stateless and therefore safe for concurrent execution, although the compilation process for a single expression is expected to be a single-threaded operation.

## API Surface
The public contract is dominated by static factory methods. The constructor is intended for internal use by subclasses.

| Symbol | Type | Complexity | Description |
| :--- | :--- | :--- | :--- |
| createFromParsedToken(operand, context) | ASTOperand | O(1) | **Primary Factory.** Creates a concrete ASTOperand node from a token generated by the Parser. This is the main entry point during compilation. |
| createFromOperand(token, pos, operand) | ASTOperand | O(1) | Creates a concrete ASTOperand node from a runtime ExecutionContext.Operand. Used for dynamic expression generation or optimization. |

**Note on Decompiled Code:** The private helper method `createFromScopeConstant` and the public `createFromOperand` could not be fully decompiled by standard tools. Bytecode analysis confirms they implement a switch on the `ValueType` enum to resolve compile-time constants or runtime values into the appropriate concrete ASTOperand subclass (e.g., ASTOperandNumber, ASTOperandString, ASTOperandBoolean). This is a form of constant folding and type-aware node creation.

## Integration Patterns

### Standard Usage
This class is not intended for direct use by most developers. It is an internal component of the expression compiler, invoked by the Parser.

```java
// Hypothetical usage within the expression compiler
Parser.ParsedToken token = parser.getNextOperandToken();
CompileContext context = compiler.getContext();

// The parser delegates creation of the AST node to the factory
ASTOperand operandNode = ASTOperand.createFromParsedToken(token, context);
ast.addNode(operandNode);
```

### Anti-Patterns (Do NOT do this)
- **Direct Instantiation:** Do not attempt to instantiate concrete subclasses like `new ASTOperandNumber(...)`. The `ASTOperand` factory methods contain critical logic for resolving identifiers and constants from the `CompileContext` and must be used to ensure correctness.
- **State Modification:** Do not use reflection or other means to modify the internal state of an operand node after its creation. The immutability of the AST is a core design principle for ensuring predictable and safe execution.

## Data Pipeline
ASTOperand is a critical transformation step in the expression compilation pipeline, converting unstructured tokens into typed, structural tree nodes.

> Flow:
> Raw Expression String -> Tokenizer -> `Parser.ParsedToken` -> **ASTOperand.createFromParsedToken** -> Concrete `ASTOperand` Node -> AST -> Compiled Expression

