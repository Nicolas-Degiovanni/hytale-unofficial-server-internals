---
description: Architectural reference for BaseHeightPositionProvider
---

# BaseHeightPositionProvider

**Package:** com.hypixel.hytale.builtin.hytalegenerator.positionproviders
**Type:** Transient Component

## Definition
```java
// Signature
public class BaseHeightPositionProvider extends PositionProvider {
```

## Architecture & Concepts
The BaseHeightPositionProvider is a concrete implementation of the Decorator pattern within the world generation framework. It acts as a wrapper around another PositionProvider, augmenting its behavior without modifying its underlying code.

Its primary architectural role is to transform a set of abstract 3D positions by adjusting their vertical component (Y-axis) to conform to a dynamic terrain surface. This is achieved by applying a provided height function, effectively draping the output of the wrapped provider onto a conceptual heightmap.

This component is fundamental for composing complex placement rules. For example, a simple GridPositionProvider can be wrapped by a BaseHeightPositionProvider to ensure that a grid of trees is placed correctly on hilly terrain, rather than at a fixed, flat altitude. It decouples the logic of *where* to place things (e.g., in a grid, scattered randomly) from the logic of *how high* to place them.

## Lifecycle & Ownership
- **Creation:** Instantiated dynamically by a higher-level generator, such as a biome or zone processor, during the setup phase of a world generation task. It is constructed with its dependenciesâ€”the function defining the surface height and the provider it will decorate.
- **Scope:** The object's lifetime is ephemeral, strictly scoped to a single, specific generation pass. It holds no state that persists beyond the invocation of its `positionsIn` method.
- **Destruction:** It becomes eligible for garbage collection as soon as the generation pass completes and the reference held by the parent generator is released. There are no manual cleanup requirements.

## Internal State & Concurrency
- **State:** The internal state of this class is immutable after construction. The `baseHeightFunction`, wrapped `positionProvider`, and Y-input bounds are final. All mutable state required for processing, such as the list of generated positions, is managed through the transient `Context` object passed into its methods.
- **Thread Safety:** This class is inherently thread-safe due to its immutable state. The overall safety of a generation pipeline using this provider depends entirely on the thread safety of the injected `baseHeightFunction` and the `consumer` within the `Context`. The design promotes safe parallelization by isolating state within the `Context` object, preventing instance-level data races.

## API Surface

| Symbol | Type | Complexity | Description |
| :--- | :--- | :--- | :--- |
| positionsIn(Context context) | void | O(N) | Processes positions from the wrapped provider. N is the number of positions generated by the child. For each position, it applies the height function and forwards the result if it remains within the original context's bounds. |

## Integration Patterns

### Standard Usage
This provider is designed to be chained with other providers. The typical use case is to take a set of X/Z coordinates from a source provider and adjust their Y-coordinate to match a terrain heightmap, which is represented by the `baseHeightFunction`.

```java
// context is a pre-configured PositionProvider.Context
// heightmapFunction is a BiDouble2DoubleFunction that returns terrain height for an (x, z) coord

// 1. Define the base positions (e.g., a simple grid)
PositionProvider grid = new GridPositionProvider(/* ... */);

// 2. Wrap the grid with the height provider to make it terrain-aware
PositionProvider terrainAwareGrid = new BaseHeightPositionProvider(
    heightmapFunction,
    grid,
    0,
    256
);

// 3. Execute the generation chain
terrainAwareGrid.positionsIn(context);
```

### Anti-Patterns (Do NOT do this)
- **Recursive Wrapping:** Wrapping a BaseHeightPositionProvider with itself or creating a circular dependency chain will result in a StackOverflowError during the `positionsIn` call.
- **Ignoring Bounds:** The provided `baseHeightFunction` should be computationally efficient. A slow function will become a major performance bottleneck, as it is invoked once for every single position generated by the wrapped provider.
- **Stateful Functions:** The `baseHeightFunction` should be pure and free of side effects. Relying on external mutable state within the function can lead to non-deterministic and incorrect results, especially in a multi-threaded generation environment.

## Data Pipeline
The flow of a single position vector through this component is a distinct, multi-step transformation. The provider intercepts the data flow between the wrapped (child) provider and the final (parent) consumer.

> Flow:
> Child PositionProvider generates `Vector3d(x, y, z)` -> `childContext.consumer` lambda is invoked -> **BaseHeightPositionProvider** calculates `baseHeight = baseHeightFunction(x, z)` -> New `Vector3d(x, y + baseHeight, z)` is created -> Bounds check against `originalContext.maxExclusive` -> `originalContext.consumer.accept()` is invoked with the new vector -> Downstream Processor / World Writer

