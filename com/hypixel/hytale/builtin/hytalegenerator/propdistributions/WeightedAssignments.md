---
description: Architectural reference for WeightedAssignments
---

# WeightedAssignments

**Package:** com.hypixel.hytale.builtin.hytalegenerator.propdistributions
**Type:** Transient / Strategy Object

## Definition
```java
// Signature
public class WeightedAssignments extends Assignments {
```

## Architecture & Concepts
The WeightedAssignments class is a fundamental component of the procedural world generation engine, acting as a composite strategy for prop placement. It orchestrates the selection of other prop distributions (represented by the Assignments interface) based on a configured set of weights. This allows world designers to create complex, layered, and non-uniform environments, such as a forest with a 70% chance of spawning an oak tree, a 20% chance of a birch tree, and a 10% chance of a clearing.

Its core architectural function is to act as a decision node within the generation pipeline. It does not generate props itself but rather delegates the final decision to a child Assignments object selected via a deterministic, weighted random roll.

The system's determinism is critical and is guaranteed by the use of a SeedGenerator. For any given world seed and 3D coordinate, the outcome of a prop selection will be identical every time, ensuring world reproducibility. A key feature is the *noneProbability* parameter, which introduces a global chance for no prop to be placed at all. This is a powerful tuning mechanism for controlling overall prop density and creating natural-looking empty space.

## Lifecycle & Ownership
- **Creation:** WeightedAssignments instances are created during the world generation configuration phase. They are typically instantiated and configured by higher-level systems like a BiomeGenerator or LayerGenerator, which parse biome or zone definition files. An instance is constructed with a pre-populated WeightedMap of child Assignments, a world seed, and probability parameters.
- **Scope:** The object's lifetime is tied to the specific generation feature it defines. It is not a long-lived, session-wide object. It exists to serve a specific rule set (e.g., "forest floor clutter") and is held by the generator responsible for that rule.
- **Destruction:** The object is eligible for garbage collection as soon as the generator that owns it completes its work or is itself discarded.

## Internal State & Concurrency
- **State:** The class is designed to be **effectively immutable**. Its internal fields, including the WeightedMap of distributions, the SeedGenerator, and probability values, are set only during construction and are not modified thereafter. This design is a deliberate and critical choice for ensuring predictable and parallelizable world generation.
- **Thread Safety:** WeightedAssignments is **thread-safe** and designed for high-concurrency environments. Its immutability prevents data races. The primary method, propAt, is fully re-entrant; it creates a new FastRandom instance for each invocation, avoiding any shared mutable state between threads. This allows multiple world generation workers (WorkerIndexer) to safely query the same WeightedAssignments instance simultaneously.

## API Surface

| Symbol | Type | Complexity | Description |
| :--- | :--- | :--- | :--- |
| propAt(position, id, distance) | Prop | O(log N) + Delegate | Determines the prop for a given coordinate. First, it calculates a deterministic random value. If the value exceeds *noneProbability*, it performs a weighted selection from N child distributions and delegates the final prop calculation. Returns Prop.noProp() if no prop should be placed. |
| getRuntime() | int | O(1) | Returns the configured runtime identifier for this distribution. |
| getAllPossibleProps() | List<Prop> | O(N * M) | Recursively traverses all child Assignments (N) and aggregates a list of every possible Prop (M) that could be generated by this distribution hierarchy. **Warning:** This can be an expensive operation and should not be called within the main generation loop. |

## Integration Patterns

### Standard Usage
WeightedAssignments is not retrieved from a central service locator. It is instantiated as part of a larger generator's configuration and used as a strategy object.

```java
// Within a BiomeGenerator or similar configuration context
WeightedMap<Assignments> forestTrees = new WeightedMap<>();
forestTrees.add(oakTreeDistribution, 70);
forestTrees.add(birchTreeDistribution, 30);

// Create the weighted assignment strategy with a 15% chance of no tree at all
Assignments treeStrategy = new WeightedAssignments(forestTrees, worldSeed, 0.15, RUNTIME_TREES);

// Later, in the generation loop for a specific coordinate
Prop propToPlace = treeStrategy.propAt(currentPosition, workerId, edgeDistance);
world.setProp(currentPosition, propToPlace);
```

### Anti-Patterns (Do NOT do this)
- **State Modification:** Do not attempt to modify the internal WeightedMap after construction. The class is not designed for runtime changes, and doing so via reflection or other means will break thread safety and determinism.
- **Non-Deterministic Inputs:** Never use a non-deterministic random source (like java.util.Random) to select a distribution from the WeightedMap. The entire world generation system relies on the deterministic SeedGenerator to produce reproducible worlds.
- **Performance-Critical Polling:** Avoid calling getAllPossibleProps frequently or within tight loops. It is a heavy inspection method intended for debugging or validation, not for core generation logic.

## Data Pipeline
The flow of data for a single prop query is a clear, deterministic sequence.

> Flow:
> World Generator requests prop at **Vector3d** -> **WeightedAssignments.propAt()** -> SeedGenerator.seedAt(x, y, z) -> FastRandom instance created -> Random roll vs **noneProbability** -> (If pass) WeightedMap.pick() selects child **Assignments** -> Child **Assignments.propAt()** -> Final **Prop** returned

